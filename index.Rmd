---
title: "Carnegie Mellon's Combined Indicator for Indiana"
output:
   flexdashboard::flex_dashboard:
      orientation: rows
      vertical_layout: scroll
      social: menu
      source_code: embed
      theme: yeti
      css: covidcast-style.css
      favicon: images/ind-state-fav.png
      logo: images/rsz_ind-state-logo.png
      navbar:
         - {icon: "fa-arrow-alt-circle-left", href: "https://ercbk.github.io/Indiana-COVID-19-Website/static.html", align: right, title: "Back to Tracker"}
---



```{r setup}
pacman::p_load(covidcastR, extrafont, dplyr, glue, leaflet, leaflet.extras, plotly, crosstalk)

# creates a color function where input is a vector with values in the domain and outputs hex colors. 30 hex values.
# combined indicator values don't get much higher than 3.00. Anything higher will have the darkest value.
pal <- colorNumeric("YlOrRd",
                    domain = seq(0.00, 3.00, by = 0.10))
# needed because leaflet legend default direction of values is backwards
pal_rev <- colorNumeric("YlOrRd",
                        domain = seq(2.50, 0.00, by = -0.10),
                        reverse = TRUE)
   
# latest combined indicator values are for previous day
date <- stringr::str_remove_all(lubridate::today()-1, "-")

```



```{r data}
# census bureau's tiger-line msa shapefiles
us_msa_tiles <- sf::read_sf(glue("{rprojroot::find_rstudio_root_file()}/data/shapefiles/msa-2019/tl_2019_us_cbsa.shp"))

# leaflet requires EPSG:4326
msa_tiles <- sf::st_transform(us_msa_tiles, 4326)
ind_msa_tiles <- msa_tiles %>% 
   filter(stringr::str_detect(NAME, "IN")) %>% 
   janitor::clean_names() %>% 
   mutate(# remove state abbrev from msa names
      name = stringr::str_remove_all(name, "([A-Z][A-Z]-)*"),
      name = stringr::str_remove_all(name, ", [A-Z]*"))

combined_index_yday <- ind_msa_tiles %>% 
   # cbsafp is the msa id
   select(name, cbsafp) %>% 
   group_by(name) %>% 
   tidyr::nest() %>% 
   # get the combined indicator value for each msa if one is available
   mutate(data = purrr::map(data, ~suppressMessages(
      covidcast_signal(
         data_source = "indicator-combination",
         signal = "nmf_day_doc_fbc_fbs_ght",
         start_day = date,
         end_day = date,
         geo_type = "msa",
         geo_values = .x$cbsafp)
   ))) %>% 
   tidyr::unnest(cols = "data") %>% 
   ungroup() %>% 
   select(-geo_value, -direction, -sample_size)

combined_index_complete <- readr::read_csv(glue("{rprojroot::find_rstudio_root_file()}/data/covidcast-msa-complete.csv"))

ci_yday <- combined_index_yday %>% 
   filter(time_value == max(time_value)) %>% 
   slice(1) %>% 
   pull(time_value)
ci_comp <- combined_index_complete %>% 
   filter(time_value == max(time_value)) %>%
   slice(1) %>% 
   pull(time_value)


# # compare dates first before adding new data
if (ci_yday != ci_comp) {
   combined_index_all <- combined_index_complete %>%
      bind_rows(combined_index_yday)
   
   readr::write_csv(combined_index_all, glue("{rprojroot::find_rstudio_root_file()}/data/covidcast-msa-complete.csv"))
} else {
   combined_index_all <- combined_index_complete
}

# Clean names
ci_clean1 <- combined_index_all %>% 
   mutate(# remove state abbrev from msa names
      name = stringr::str_remove_all(name, "([A-Z][A-Z]-)*"),
      name = stringr::str_remove_all(name, ", [A-Z]*")
   )


```



```{r clean-leaflet}
# leaflet map: add popup text, styling
ci_clean2 <- ci_clean1 %>%
   # create popup text
   mutate(value = round(value, 2),
          color = pal(value),
          # white map background so darkening the palette some
          color = prismatic::clr_darken(color,
                                        shift = 0.20),
          # dark-red background for high values needs white text
          value_text = ifelse(value >= 2,
                              glue("<b style='background-color:{color}; font-family:Roboto; font-size:15px; color:white'>{value}</b>"),
                              glue("<b style='background-color:{color}; font-family:Roboto; font-size:15px'>{value}</b>")),
          popup = glue("<b style= 'font-family:Roboto; font-size:15px'>{name}</br>Combined Indicator</b>: {value_text}")) 

```



```{r clean-plotly-db}
# dumbbell: add 95% CI, styling
ci_clean3 <- ci_clean2 %>% 
   mutate(upper = round(value + (1.96 * stderr), 2),
          lower = round(value - (1.96 * stderr), 2),
          value = round(value, 2),
          upper_col = prismatic::clr_darken(pal(upper),
                                            shift = 0.20),
          lower_col = prismatic::clr_darken(pal(lower),
                                            shift = 0.20),
          # contrast text against label color
          text_col = ifelse(value > 2, 'white', 'black'))

```



```{r shared}

ci_clean4 <- ci_clean3 %>% 
   # add the polygon geometries for each msa
   left_join(ind_msa_tiles, by = "name")
ci_clean_yday <- ci_clean4 %>% 
   filter(time_value == max(time_value)) %>%
   mutate(name = forcats::as_factor(name) %>%
             forcats::fct_reorder(value)) %>% 
   # converts tibble to a sf object for leaflet
   sf::st_as_sf()

ci_shared_line <- SharedData$new(ci_clean4,
                                 ~name,
                                 group = "covidcast")
ci_shared_yday <- SharedData$new(ci_clean_yday,
                                 ~name,
                                 group = "covidcast")


```




About {data-icon="fa-question-circle"}
=====================================


<H2>Description</H2>

Carnegie Mellon University's Delphi Research Group derives it's "Combined" indicator from multiple data sources that include:<br>

<UL>
<LI><U>Doctor Visits</U> - Percentage of doctor's visits that are due to COVID-like symptoms<br> 
<LI><U>Hospital Admissions</U> - Daily hospital admissions with COVID diagnostic codes.<br>
<LI><U>Symptoms</U> (Facebook) - Random Facebook users are directed to a survey that asks for the number of household members with COVID-like symptoms.<br>
<LI><U>Symptoms in Community</U> (Facebook) - Same as for "Symptoms" but asks about people they know outside of their household.<br>
<LI><U>Hours Away from Home</U> (SafeGraph) - Uses mobile phone location data to estimate the proportion of people outside their homes during daytime hours.<br>
<LI><U>Search Trends</U> (Google) - Google searchs for COVID-related topics relative to an area's population<br>
</UL>
<P>

The higher the combined indicator value, the greater the signaling of higher COVID-19 prevalence in that [metropolitan area (MSA)](https://www.census.gov/programs-surveys/metro-micro/about.html). The value has no upper bound, but for reference, here are some of the combined indicator values from some of the hotspots around the country as of July 3rd, 2020.<br>
<UL>
<LI>San Antonio, Texas: 2.69<br>
<LI>Phoenix, Arizona: 1.92<br>
<LI>Naples, Florida: 2.76<br>
</UL>


Only metropolitan areas in Indiana with sufficient data have combined indicator values calculated, so not all areas are shown in the map. More details about the methodology behind this project can be found on their [website](https://covidcast.cmu.edu/index.html?sensor=doctor-visits-smoothed_adj_cli&level=county&region=42003&date=20200701&signalType=value).


<H2> Charts </H2>

<H4> Line </H4>

The grouped line chart shows historic combined indicator values for each MSA.<br>

<UL>
<LI>Clicking a line highlights the line and deemphasizes the others. Multiple lines can be highlighted. Highlighting a line also has the same effect on that MSA's error bar in the dumbbell chart.<br>
<LI>Clicking on the brush color in the top-left allows you to change the default color (red) to either blue, green, or purple.<br>
<LI>Drawing a window around a section of the chart zooms into that time window  
<LI>Pan or Zoom-out (toolbar) can be useful for looking at edge values  
<LI>Home button (toolbar) or double-clicking in the plot area resets the chart  
<LI>Compare-data-on-hover button (toolbar) shows every label for each MSA as you move your cursor across the days.
</UL>


<H4> Dumbbell </H4>

The dumbbell chart shows the combined indicator value (gray) and the 95% confidence interval.  

<UL>
<LI> Clicking on a point, highlights that MSA's value and deemphisizes the others. It also has the same effect for the MSA's values in the line chart. Multiple MSA values may be selected.<br>
<LI> Double-clicking in the plot area resets the chart. 
</UL>


<H4> Map </H4>

The map shows the metropolitan statistical areas that have calculated combined indicator values.  

<UL>
<LI> Hovering over an area highlights the borders of that area.  
<LI> Clicking on an area shows its estimated combined indicator value.  
<LI> Reset button (upper-left) resets the map view. It's a bit buggy, so you might need to refresh the webpage instead.
</UL>




Dashboard {data-icon="glyphicon-stats"}
=====================================


Row {data-height=360}
-------------------------------------


### Historic Values 


```{r}
# styling for axes labels and ticks
x_style_line <- list(
   title = "Combined indicator over time",
   titlefont = list(
      color = "black",
      face = "bold",
      size = 18
   ),
   tickfont = list(
      face = "bold",
      size = 14
   )
)

y_style_line <- list(
   title = "",
   tickfont = list(
      color = "black",
      face = "bold",
      size = 16
   )
)



ci_shared_line %>%
   # group_by(name) %>% 
   plot_ly(x = ~time_value, y = ~value,
           color = I("black"), split = ~name,
           text = ~name,
           # <extra> part removes "trace" from text
           hovertemplate = paste(
              "%{x}<br>",
              "<b>%{text}</b><br>",
              "Combined: %{y}",
              "<extra></extra>"
           ),
           hoverlabel = list(
              #bgcolor = ~color,
              align = 'left',
              bordercolor = 'transparent',
              font = list(
                 # need b/c of bug with setting border to 'transparent'
                 #color = ~text_col
                 color = 'white'
              )
           )
   ) %>%
   add_lines(showlegend = FALSE) %>% 
   layout(xaxis = x_style_line,
          yaxis = y_style_line,
          showlegend = FALSE,
          # sets global value for font family
          font = list(family = "Roboto"),
          # x-axis tick labels get cut off with default margin
          margin = list(b = 90)
   ) %>% 
   highlight(dynamic = TRUE, persistent = TRUE)



```




Row {data-height=625}
-------------------------------------



### Metropolitan Statistical Areas 


```{r}
# minzoom is the maximum you can zoomout; viceversa for maxzoom; 0 would be for zooming all the out
leaflet(data = ci_shared_yday,
        options = leafletOptions(minZoom = 6.5,
                                 maxZoom = 18,
                                 # remove caption
                                 attributionControl = FALSE)) %>% 
   # black and white basemap
   addProviderTiles("Stamen.Toner") %>% 
   # sets starting point; coords for center of Indiana
   setView(lat = 40.2672, lng = 86.1349,
           zoom = 7) %>% 
   # set panning range; if user tries to go beyond, it springs back
   setMaxBounds(lat1 = 37.62598, lng1 = -89.53418,
                lat2 = 42.64689, lng2 = -83.05625) %>% 
   # add msa shapes
   addPolygons(# weight is thickness of stroke
               weight = 2, smoothFactor = 0.5,
               opacity = 1.0, fillOpacity = 0.5,
               color = ~color, popup = ~popup,
               popupOptions = ,
               # bringtofront makes highlight stroke standout more
               highlightOptions = highlightOptions(color = "black", weight = 2,
                                                   bringToFront = TRUE)) %>% 
   addLegend("bottomleft", pal = pal_rev,
             opacity = 1, values = c(2.5, 0.5),
             # reverses direction of values in legend
             labFormat = labelFormat(transform = function(x) sort(x, decreasing = TRUE))
   ) %>% 
   # {leaflet.extras}
   addResetMapButton()


```



### Uncertainty


```{r}

# styling for axes labels and ticks
x_style_db <- list(
   title = "Combined indicator with uncertainty range",
   titlefont = list(
      color = "black",
      face = "bold",
      size = 18
   ),
   tickfont = list(
      face = "bold",
      size = 14
   )
)

y_style_db <- list(
   title = "",
   tickfont = list(
      color = "black",
      face = "bold",
      size = 16
   )
)


ci_shared_yday %>% 
   plot_ly(y = ~name,
           text = ~name,
           # <extra> part removes "trace" from text
           hovertemplate = paste(
              "<b>%{text}</b><br>",
              "Combined: %{x}",
              "<extra></extra>"
           ),
           hoverlabel = list(
              bordercolor = 'transparent',
              font = list(
                 # need b/c of bug with setting border to 'transparent'
                 color = ~text_col
              )
           )) %>%
   # removes toolbar
   config(displayModeBar = F) %>% 
   add_segments(
      # "~" are for variables in df
      x = ~lower,
      xend = ~upper, yend = ~name, 
      # "I" means asis
      color = I("gray")
   ) %>%
   add_markers(
      x = ~lower, 
      color = ~I(lower_col), size = I(65)
   ) %>%
   add_markers(
      x = ~upper, 
      color = ~I(upper_col), size = I(65)
   ) %>%
   add_markers(
      x = ~value,
      color = I("gray"), size = I(40)
   ) %>% 
   layout(xaxis = x_style_db,
          yaxis = y_style_db,
          showlegend = FALSE,
          # sets global value for font family
          font = list(family = "Roboto")
   ) %>% 
   highlight(persistent = TRUE)



```   




